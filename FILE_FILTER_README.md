# 文件过滤功能说明

## 🎯 功能概述

云外端现在具备智能文件过滤功能，可以自动识别和跳过无法处理的文件，避免解密失败导致的错误。

## 🔧 新增配置选项

### 文件过滤配置
- **MIN_FILE_SIZE**: 最小文件大小（字节）
  - 默认值：100
  - 小于此值的文件将被自动跳过
  - 建议值：100-500字节

- **AUTO_DELETE_INVALID**: 自动删除无效文件
  - 默认值：True
  - 设置为True时，无法处理的文件会被自动删除
  - 设置为False时，只跳过不删除

## 📝 配置示例

在 `config.ini` 中添加：

```ini
[DEFAULT]
# 文件过滤配置
MIN_FILE_SIZE = 100
AUTO_DELETE_INVALID = True
```

## 🚀 工作流程

1. **文件下载**: 下载文件到本地
2. **大小检查**: 检查文件大小是否小于最小阈值
3. **智能过滤**: 
   - 如果文件太小 → 跳过并删除（可选）
   - 如果文件正常 → 继续处理
4. **解密尝试**: 尝试解密文件
5. **失败处理**: 
   - 解密失败 → 记录错误信息并删除文件
   - 解密成功 → 正常处理

## 💡 使用建议

### 对于小文件（<100字节）
- 通常是系统生成的临时文件
- 不是我们系统的加密文件
- 建议自动跳过和删除

### 对于解密失败的文件
- 可能是其他人上传的
- 加密方式不同
- 建议自动删除，避免重复尝试

### 配置调优
- 如果经常遇到小文件，可以适当提高 `MIN_FILE_SIZE`
- 如果不想自动删除，可以设置 `AUTO_DELETE_INVALID = False`

## 🔍 日志示例

```
[11:28:18] 🔍 开始处理文件: clipboard_payload_123.txt (ID: 456)
[11:28:18] 🔗 下载URL: http://emap.wisedu.com/...
[11:28:18] 📥 下载成功，文件大小: 248 字节
[11:28:18] ⚠️ 跳过小文件: clipboard_payload_123.txt (248 字节 < 500 字节)
[11:28:18] 🗑️ 已删除小文件: clipboard_payload_123.txt
```

## 🛠️ 故障排除

### 问题：仍然看到解密失败
**解决方案**：
1. 检查 `MIN_FILE_SIZE` 设置是否合适
2. 确认 `AUTO_DELETE_INVALID = True`
3. 查看日志中的文件大小信息

### 问题：误删了有用文件
**解决方案**：
1. 设置 `AUTO_DELETE_INVALID = False`
2. 调整 `MIN_FILE_SIZE` 到更小的值
3. 手动检查被跳过的文件

## 📊 性能影响

- **正面影响**：减少无效文件处理，提高效率
- **负面影响**：轻微增加配置复杂度
- **建议**：在生产环境中启用此功能
